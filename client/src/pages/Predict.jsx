
import React, { useState } from "react";
import jsPDF from "jspdf";
import autoTable from "jspdf-autotable";

function Predict() {
  const normalRanges = {
    Age: "20â€“45 years",
    BMI: "18.5â€“24.9",
    BloodPressure: "80â€“130 mmHg",
    DiabetesPedigreeFunction: "< 0.6",
    Glucose: "70â€“140 mg/dL",
    Insulin: "15â€“276 uU/mL",
    Pregnancies: "0â€“10",
    SkinThickness: "10â€“50 mm",
  };

  const [formData, setFormData] = useState({
    Pregnancies: "",
    Glucose: "",
    BloodPressure: "",
    SkinThickness: "",
    Insulin: "",
    BMI: "",
    DiabetesPedigreeFunction: "",
    Age: "",
  });

  const [report, setReport] = useState(null);
  const [showOverview, setShowOverview] = useState(false);

  //  Handle input changes
  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  //  Submit for prediction
  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      const res = await fetch("http://127.0.0.1:5000/predict", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams(formData),
      });
      const data = await res.json();
      setReport(data);
      setShowOverview(false);

      //  Save to MongoDB (backend)
      const token = localStorage.getItem("token");
      if (token && data.prediction) {
        await fetch("http://localhost:5000/api/predictions/save", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            inputs: formData,
            result: data.prediction.includes("Positive")
              ? "Positive (Diabetic)"
              : "Negative (Non-Diabetic)",
          }),
        });
      }
    } catch (error) {
      alert("âš ï¸ Error connecting to the ML service. Please ensure Flask is running.");
    }
  };

  //  Generate clean UTF-8-safe PDF
  const downloadPDF = () => {
    if (!report) return;

    const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });

    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("DIABETES PREDICTION REPORT", 14, 20);

    doc.setFont("helvetica", "normal");
    doc.setFontSize(12);
    doc.text("Generated by: Diabetes Predictor - Sahana Reddy", 14, 30);
    doc.text(`Date: ${new Date().toLocaleString()}`, 14, 37);

    doc.setFontSize(13);
    doc.setTextColor(0, 102, 204);
    doc.text(`Result: ${report.prediction}`, 14, 50);
    doc.setTextColor(0, 0, 0);

    const tableData = Object.entries(report.overview).map(([k, v]) => [
      k,
      v.value,
      normalRanges[k] || "-",
      v.status.replace(/[^\x00-\x7F]/g, ""),
    ]);

    autoTable(doc, {
      startY: 60,
      head: [["Parameter", "Entered Value", "Normal Range", "Status"]],
      body: tableData,
      theme: "grid",
      headStyles: {
        fillColor: [22, 160, 133],
        textColor: 255,
        halign: "center",
        fontStyle: "bold",
      },
      bodyStyles: { textColor: 30 },
      alternateRowStyles: { fillColor: [245, 245, 245] },
      styles: { font: "helvetica", fontSize: 11 },
    });

    const finalY = doc.lastAutoTable.finalY + 10;
    doc.setFontSize(11);
    doc.setTextColor(100);
    doc.text("Â© 2025 Diabetes Predictor | Developed by Sahana Reddy", 14, finalY);

    doc.save("Diabetes_Report.pdf");
  };

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-900 text-white px-4">
      {/* --- Header --- */}
      <div className="text-center mb-6">
        <h1 className="text-4xl font-bold text-blue-400">ðŸ©º Diabetes Prediction App</h1>
        <p className="text-gray-300 mt-2">
          Predict your health with accuracy using Machine Learning
        </p>
      </div>

      {/* --- Form Section --- */}
      <div className="bg-gray-800 rounded-2xl p-8 w-full max-w-md shadow-lg">
        <h2 className="text-2xl text-teal-400 text-center mb-4 font-semibold">
          Input Health Details
        </h2>

        <form onSubmit={handleSubmit} className="flex flex-col space-y-4">
          {Object.keys(formData).map((key) => (
            <input
              key={key}
              type="number"
              name={key}
              placeholder={key.replace(/([A-Z])/g, " $1")}
              value={formData[key]}
              onChange={handleChange}
              className="p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-2 focus:ring-teal-400"
              required
            />
          ))}

          <button
            type="submit"
            className="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 rounded-lg transition duration-200 ease-in-out"
          >
            Predict
          </button>
        </form>

        {/* --- Prediction Result --- */}
        {report && (
          <div className="text-center mt-6">
            <div
              className={`p-4 rounded-lg ${
                report.prediction.includes("Positive")
                  ? "bg-red-900/40 border border-red-500 text-red-300"
                  : "bg-green-900/40 border border-green-500 text-green-300"
              }`}
            >
              {report.prediction}
            </div>

            <div className="flex justify-center gap-4 mt-4">
              <button
                onClick={() => setShowOverview(!showOverview)}
                className="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg"
              >
                {showOverview ? "Hide Overview" : "Show Overview"}
              </button>
              <button
                onClick={downloadPDF}
                className="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-lg"
              >
                 Download Report
              </button>
            </div>

            {/* --- Overview --- */}
            {showOverview && (
              <div className="mt-6 overflow-x-auto">
                <table className="w-full text-sm text-left border border-gray-700">
                  <thead className="bg-gray-700 text-gray-300">
                    <tr>
                      <th className="p-2">Parameter</th>
                      <th className="p-2">Value</th>
                      <th className="p-2">Normal Range</th>
                      <th className="p-2">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {Object.entries(report.overview).map(([key, val]) => (
                      <tr key={key} className="border-t border-gray-700">
                        <td className="p-2">{key}</td>
                        <td className="p-2">{val.value}</td>
                        <td className="p-2">{normalRanges[key] || "-"}</td>
                        <td className="p-2">{val.status}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        )}
      </div>

    </div>
  );
}

export default Predict;
